
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On deploying a neural net to AWS Lambda</title>
    <meta name="description" content="">
    <meta name="keywords" content="reuben son, nyc, software engineer, private chronology, electronic music, ceramics">
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta property="og:title" content="On deploying a neural net to AWS Lambda" />
    <meta property="og:description" content="" />
    
    
    
    <meta property="og:image" content="https://reubenson-portfolio.s3.us-east-1.amazonaws.com/assets/portrait_2024.jpg" />
    <meta property="og:type" content="website" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ibarra+Real+Nova:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
<style>
  h1, h2, h3, h4, h5, h6 {
    font-family: "Ibarra Real Nova", serif;
    font-weight: 300;
  }
</style>

    <style>
  
  
.broider {
  border-image: url('/public/border-clean.svg') 92 92 repeat;
  border-width: 9px;
  border-style: solid;
}

@media print {
  .broider {
    border: none;
  }
}


</style>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-90GXJSKXY9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-90GXJSKXY9');
</script>
    
    
    
    
  </head>
  <body class="project ">
    
    <nav class="main-nav">
  <a class="home" href="/">Home</a>
  <a class="about" href="/about">About</a>
  <a class="works" href="/works">Works</a>
  <a class="shop" href="/shop">Shop</a>
  <script>
    const path = window.location.pathname.replace(/\//g, '');
    const navLinks = document.querySelectorAll('nav a');

    if (path === '') {
      navLinks[0].classList.add('active');
    } else {
      navLinks.forEach(link => {
        if (link.href.includes(path)) {
          link.classList.add('active');
        }
      });
    }
  </script>
</nav>

    <div class="top-spacer"></div>
    <div class="content">
      <header>
        <h1>On deploying a neural net to AWS Lambda</h1>
        <p>Week 5 at Recurse Center</p>
      </header>
      
      <div class="project-meta">
        
        
        
        
      </div>
      
      <div class="content-wrapper ">
        <h3>Week 5 at Recurse Center</h3>
<p>I’m heading into my last week at Recurse, and feeling an excited rush to wrap up the MIDI archive project I began ruminating on the previous week. The shape of it has been slowly coming together, and what remains to be seen is how much I can manage to deploy in the handful of days I have left. At the moment, the project looks something like the following, involving many components beyond just neural net model.</p>
<figure>
<img src="https://mermaid.ink/img/pako:eNplUsFqGzEQ_ZVBJwXiQujNh4LttR1DCgUHmqSbw1ia3RXRStuR1ls35N8r7W5JQ3UaoffezLynV6G8JrEUlfWDapAj3Belg3RW8qgYO-IrWCy-PMnCD8561PD1UBygMpYCVOxbOLhI7CjCilVjznQ18Z8yDdbySHymiYQhUAxwNgh7E5v-9A3rpDKkGkLEaNQimEhQkyNOV--gQact6QlzcxMvs_p6VN_IHUXVwKffpgNf_Tta9NAHSi0hMhpnXA2pOVSewVHPaCGP3Kbt7Sy5yZLbH_cZ_h_mecJsM-ZRbn91nj-yH8eBdrKgzvpLbr_6foQ7bE8aZ8huhDzIAo29wMb6Xg-Yx49s6joZPcEeRthe7icXZu8C_ezJqbSR0xAwWZpaHD9_sKOQdzkg79LTSJoTgYFO2dgZXIzgg1yzHwIxKGvIRVDeOVJzPpnh1UuOK4lNa-SKSZH5m-eJUzuFIc7Ct_J9qcW8VMpuZjOhDu8RTZ8nbTBNMynsU31bOnEtWuIWjU5f8zU_lSI21FIplqnUyC-lKN1bwmEf_fHilFhG7ula9J1OnhUGa8ZWLCu0gd7-ANel7tU?type=png" alt="drawing" style="max-width:500px;"/>
<figcaption>Flow diagram for the MIDI Archive</figcaption>
<!-- source: https://mermaid.live/edit#pako:eNplUsFqGzEQ_ZVBJwXiQujNh4LttR1DCgUHmqSbw1ia3RXRStuR1ls35N8r7W5JQ3UaoffezLynV6G8JrEUlfWDapAj3Belg3RW8qgYO-IrWCy-PMnCD8561PD1UBygMpYCVOxbOLhI7CjCilVjznQ18Z8yDdbySHymiYQhUAxwNgh7E5v-9A3rpDKkGkLEaNQimEhQkyNOV--gQact6QlzcxMvs_p6VN_IHUXVwKffpgNf_Tta9NAHSi0hMhpnXA2pOVSewVHPaCGP3Kbt7Sy5yZLbH_cZ_h_mecJsM-ZRbn91nj-yH8eBdrKgzvpLbr_6foQ7bE8aZ8huhDzIAo29wMb6Xg-Yx49s6joZPcEeRthe7icXZu8C_ezJqbSR0xAwWZpaHD9_sKOQdzkg79LTSJoTgYFO2dgZXIzgg1yzHwIxKGvIRVDeOVJzPpnh1UuOK4lNa-SKSZH5m-eJUzuFIc7Ct_J9qcW8VMpuZjOhDu8RTZ8nbTBNMynsU31bOnEtWuIWjU5f8zU_lSI21FIplqnUyC-lKN1bwmEf_fHilFhG7ula9J1OnhUGa8ZWLCu0gd7-ANel7tU -->
</figure>
<p>Since the details of this loose architecture diagram are subject to change, I’ll focus on it more in my next post, and instead would like to reflect more on the <code>AWS Lambda</code> portion of the diagram.</p>
<p>I’m not yet sure if this project is something I’ll keep working on, or if I’ll let it stay in some form as a proof of concept, but I’d like to deploy in a low-cost and low-maintenance way that would allow me to let it passively exist online with minimal billing and upkeep. While there’s lots of options to deploy ML models to production, I set my sights on Lambda early on because of its usage-based pricing model where I can have the service turned off from most of the day. The model I’ve built so far has pretty limited utility, certainly not sophisticated enough to be useful for generating actual music or aiding the process of composing, so there’s little to warrant it having very much server uptime.</p>
<p>But this limitation also feels ripe for some creative elaboration, and I’ve been circling around the idea of having the ML model present daily “performances”, in which visitors to the site can hear some music generated by the model. The general inspiration of this comes from <a href="https://solar.lowtechmagazine.com/">Low Tech Magazine</a>, which is hosted on a solar-powered server that sometimes goes down if the weather is cloudy for too long and the battery depletes. Or <a href="https://radioamnion.net/">Radio Amnion</a>, which only broadcasts for a few days around each new moon. There’s something beautiful about these websites that have variable behavior depending on time or atmospheric conditions.</p>
<p>As for right now, the plan is to have two separate Lambda functions, each of which is only invoked once a day. The first is responsible for serving the machine learning model, and will generate a MIDI sequence that is stored in S3. The second is then responsible for broadcasting that MIDI file over websockets to visitors to the site. Lambdas have a maximum execution time of 15 minutes, which will also limit the duration of the broadcast. An important detail of this, too, is that all visitors to the site will experience the same broadcast at the same time, which to me makes it more of a “performance” than just letting visitors play the MIDI file as they please.</p>
<p>In terms of implementation, I’ve been struggling to get the model hosted in Lambda, as I hadn’t quite realized how <strong>beefy</strong> the <code>PyTorch</code> library is, which I’ve been using to build and train the model, and is far too large for Lambda’s filesize limitations. At first I tried to use an existing tool called <a href="https://github.com/szymonmaszke/torchlambda">torchlambda</a> to minimize and deploy my trained model, but should have taken the fact that it hadn’t been updated in three years as a red flag. In that time, PyTorch has gone through a major version change, and made torchlambda rather unsuitable.</p>
<p>At the same time, it was interesting to me that torchlambda used something called <a href="https://pytorch.org/tutorials/beginner/Intro_to_TorchScript_tutorial.html">torchscript</a> to compile a model to C++, and vastly minimize the size of source code and dependencies to be deployed to Lambda. But as I was considering going further down this path, <a href="https://github.com/kenjinp">Kenny</a>, a fellow Recurse resident suggested that I look into <a href="https://onnx.ai/">https://onnx.ai/</a>, which aims to bring interoperability to the growing ecosystem of various ML libraries and runtime environments. The Onnx runtime, unlikely PyTorch, is relatively small (~45 MB), and falls within Lambda’s filesize restrictions. After a quick test run, loosely following suggestions <a href="https://becominghuman.ai/onnx-inference-with-python-in-aws-lambda-f09d08530e87">here</a>, I’ve set up a toy model deployed to Lambda using the Onnx runtime packaged into a Lambda layer, and happy to report that it’s functioning as expected!</p>

      </div>

      
      <section class="project-more">
        <h2>See also</h2>
        <ul>
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          
        </ul>
      </section>
      
    </div>
    <div class="chop-container">
  <div class="chop-wrapper">
    <div class="chop-border"></div>
    <div class="chop-border inner"></div>
    <svg viewBox="0 0 400 400" width="200" height="200">
    <path id="topPath"
      d="M200,200 m-150,0 a150,150 0 1,1 300,0"
      fill="none"
      transform="rotate(11, 200, 200)"/>
    <path id="bottomPath"
      d="M200,200 m150,0 a150,150 0 1,1 -300,0"
      fill="none"
      transform="rotate(28, 200, 200)"/>
    <text>
      <textPath href="#topPath">
      REUBEN
      </textPath>
    </text>
    <text>
      <textPath href="#bottomPath">
      NOS
      </textPath>
    </text>
    </svg>
    <div class="chop"></div>
  </div>
  <svg style="display: none;">
    <filter id="white-to-transparent">
      <feColorMatrix type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        -1 -1 -1 1 1
      "/>
    </filter>
  </svg>
</div>

<style>
  .chop-container {
    position: absolute;
    width: 150px;
    height: 150px;
    overflow: hidden;
    opacity: 0.8;
  }

  .chop-wrapper {
    filter: blur(1.1px) contrast(5) url(#white-to-transparent);
    background-color: white;
    height: 100%;
    width: 100%;
  }

  .chop-container svg {
    position: absolute;
    bottom: 0;
    right: 0;
    top: 0;
    left: 0;
    margin: auto;
    overflow: visible;
  }

  .chop {
    width: 30%;
    background-image: url('/public/chop-2.png');
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    transform: scaleX(-1);
    position: absolute;
    bottom: 0;
    right: 0;
    top: 0;
    left: 0;
    margin: auto;
    opacity: 0.9;
  }

  .chop-border {
    border: solid black 2px;
    border-radius: 50%;
    height: 70%;
    width: 70%;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    margin: auto;
  }

  .chop-border.inner {
    display: none;
    height: 55%;
    width: 55%;
  }

  .chop-container text {
    font-size: 40px !important;
    letter-spacing: 10px;
    font-weight: bold;
    font-family: Arial, Helvetica, sans-serif;
    opacity: 0.9;
  }

  .homepage .chop-container {
    z-index: 0;
  }

  .project .chop-container,
  .shop-page .chop-container {
    opacity: 0.025;
    z-index: -1;
  }

</style>

<script>
  // randomize position
  const leftRange = [5, 60];
  const topRange = [-5, 15];
  const chopContainer = document.querySelector('.chop-container');
  const randomX = Math.random() * (leftRange[1] - leftRange[0]) + leftRange[0];
  const randomY = Math.random() * (topRange[1] - topRange[0]) + topRange[0];
  chopContainer.style.left = `${randomX}%`;
  chopContainer.style.top = `${randomY}%`;

  // randomize rotation
  const rotationRange = [-50, 100];
  const randomRotation = Math.random() * (rotationRange[1] - rotationRange[0]) + rotationRange[0];
  chopContainer.style.transform = `rotate(${randomRotation}deg)`;
</script>
    <div class="page-border broider"></div>
  </body>
</html>